{"meta":{"title":"寂情啊的blog","subtitle":"副标题","description":"这是一个测试的blog","author":"寂情啊","url":"http://www.jiqinga.top","root":"/"},"posts":[{"title":"使用kubeadm快速安装kubernetes集群","date":"2020-06-18T01:51:32.000Z","path":"2020/06/18/使用kubeadm快速安装kubernetes集群/","raw":"---\ntitle: 使用kubeadm快速安装kubernetes集群\ntags:\n  - docker\n  - k8s\ncategories:\n  - k8s-install\ndate: 2020-06-18 09:51:32\n---\n\n\n\n# 安装前设置\n\n##  关闭防火墙\n\n```bash\nsystemctl disabled firewalld\nsystemctl stop firewall\n```\n\n##  关闭SELinux\n\n```bash\nsetenforce 0\nsed -i 's/^SELINUX=enforcing$/SELINUX=disabled/' /etc/selinux/config\nreboot\n```\n\n##  内核优化(防止kubeadm init报错)\n\n```\necho 1 > /proc/sys/net/bridge/bridge-nf-call-iptables\necho 1 > /proc/sys/net/bridge/bridge-nf-call-ip6tables\n```\n\n\n\n##  禁用swap交换分区(可以不禁用,官方建议禁用)\n\n```bash\nswapoff -a && sed -i '/ swap / s/^/#/' /etc/fstab\n```\n\n\n\n#  安装Kubeadm、Kubelet、Kubectl\n\n##  配置yum源\n\n```bahs\ncat <<EOF > /etc/yum.repos.d/kubernetes.repo\n[kubernetes]\nname=Kubernetes Repository\nbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/\nenabled=1\ngpgcheck=0\nEOF\n```\n\n##  安装\n\n> 安装最新版本去掉版本号即可\n\n```bash\nyum -y install kubelet-1.14.0 kubeadm-1.14.0 kubectl-1.14.0 --disableexcludes=kubernetes\n```\n\n#  kubectl补全\n\n```\necho \"source <(kubectl completion bash)\" >> ~/.bashrc && source ~/.bashrc\n```\n\n\n\n##  设置kubelet忽略交换分区(已禁用swap可跳过此步)\n\n```bash\nsed -i '/KUBELET_EXTRA_ARGS=/ s/$/\"--fail-swap-on=false\"/' /etc/sysconfig/kubelet\n```\n\n\n\n##  设置服务开机自启\n\n```bash\nsystemctl  enable kubelet && systemctl enable docker\n```\n\n#  生成默认初始化参数文件\n\n```bash\nkubeadm config print init-defaults > init.default.yaml\n#根据需要进行修改\ncat <<EOF > init-config.yaml\napiVersion: kubeadm.k8s.io/v1beta1\nimageRepository: registry.aliyuncs.com/google_containers\nkind: ClusterConfiguration\nkubernetesVersion: v1.14.0\nnetworking:\n  podSubnet: \"192.168.0.0/16\"\nEOF\n```\n\n#  下载Kubernetes镜像\n\n```bash\nkubeadm config images pull --config=init-config.yaml\n```\n\n#  运行kubeadm init安装master\n\n```bash\nkubeadm init --config=init-config.yaml --ignore-preflight-errors=swap | grep \"kubeadm join\" > node-join.txt\n```\n\n##   根据提示执行命令\n\n```bash\nmkdir -p $HOME/.kube\nsudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\nsudo chown $(id -u):$(id -g) $HOME/.kube/config\n```\n\n#  移除master污点\n\n> master节点在默认情况下并不参与工作负载,如果希望master工作或安转单节点k8s集群,需要移除master污点,使其成为一个node工作节点.\n\n```bash\nkubectl taint nodes --all node-role.kubernetes.io/master-\n```\n\n#  安装weave网络插件\n\n> 此次使用weave网络插件,详情可参考[官方文档]( https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#pod-network )\n\n```bash\nkubectl apply -f \"https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\\n')\"\n```\n\n\n\n***\n\n#  node节点加入集群\n\n##  node节点安装前设置\n\n**[^2]:参考上方master安装前设置**\n\n##  安装kubeadm，kubelet\n\n[^1]:需配置yum源,可参考上方yum配置\n\n```bash\nyum -y install kubelet-1.14.0 kubeadm-1.14.0  --disableexcludes=kubernetes\n```\n\n##  获取token\n\n> 默认master节点token一天后过期,或者忘记加入节点token,可以手动生成\n\n```bash\nkubeadm token create --print-join-command --ttl 0\n```\n\n##  加入节点\n\n```bash\nkubeadm join 182.10.1.161:6443 --token jcs77d.l64dq5la17l5hivr     --discovery-token-ca-cert-hash sha256:80b8d22d30b07526dd8dadc91414dfb1fd17467e7b8c4dc0199831f710c72294 --ignore-preflight-errors=swap\n```\n\n#  查看节点状态(master)\n\n```bash\nkubectl  get po --all-namespaces -w\n```\n\n","permalink":"http://www.jiqinga.top/2020/06/18/%E4%BD%BF%E7%94%A8kubeadm%E5%BF%AB%E9%80%9F%E5%AE%89%E8%A3%85kubernetes%E9%9B%86%E7%BE%A4/","categories":[{"name":"k8s-install","slug":"k8s-install","permalink":"http://www.jiqinga.top/categories/k8s-install/"}],"tags":[{"name":"docker","slug":"docker","permalink":"http://www.jiqinga.top/tags/docker/"},{"name":"k8s","slug":"k8s","permalink":"http://www.jiqinga.top/tags/k8s/"}]}],"categories":[{"name":"k8s-install","slug":"k8s-install","permalink":"http://www.jiqinga.top/categories/k8s-install/"}],"tags":[{"name":"docker","slug":"docker","permalink":"http://www.jiqinga.top/tags/docker/"},{"name":"k8s","slug":"k8s","permalink":"http://www.jiqinga.top/tags/k8s/"}]}